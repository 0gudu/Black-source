<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">guduitsource - Teste de comando de partida</span>
        </div>
    </nav>

    <div class="container mt-3">
        enviar comando  
        <div class="row">
            <div class="col">
                <input type="text" class="form-control" placeholder="port" value="27015" id="port">
                <input type="text" class="form-control" placeholder="ip" value="199.195.250.174" id="ip">
            </div>
            <div class="col">
                <input type="text" class="form-control" placeholder="command" id="command">
            </div>
            <div class="col">
                <button class="btn btn-primary" onclick="enviarRequisicao()">enviar</button>
            </div>
            <div class="col">
                <button class="btn btn-primary" onclick="mixstart()">Começar Mix</button>
                <button class="btn btn-primary" onclick="mixstop()">Encerrar Mix</button>
                <p id="mixx">Mix off</p>
            </div>
        
        </div>
        <div id="resultado2"></div>
        <div class="row mt-3">
            <div id="playerss" class="col">
                <div id="resultado"></div>
            </div>
            <div class="container">
                <div class="row">
                <h6 id="round">ROUND 1</h6>
                  <div class="col">
                    <h1 id="ctscore">CT - 0</h1>
                    <div id="ct">

                    </div>
                  </div>
                  <div class="col">
                    <h1 id="trscore">TR - 0</h1>
                    <div id="tr">

                    </div>
                  </div>
                </div>
              </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        //update scores and players
        setInterval(function() {
            players();
        }, 5000);
        setInterval(function() {
            scoreupdate();
        }, 7000);

        function enviarRequisicao(){
            $.ajax({
                    url: "https://215ch.co/css/api1.php", 
                    type: "get", 
                    data: {
                        ip: $("#ip").val(),
                        port: $("#port").val(),
                        command: $("#command").val()
                    },
                    error: function(xhr, status, error) {
                        // Lidar com erros
                        console.error("Erro:", status, error);
                    },
                    success: function(msg) {
                        $("#resultado2").html("Comando resposta: "+ msg);
                        $("#command").val("");
                    }
                });
        }
        function mixstart(){
            $.ajax({
                    url: "https://215ch.co/css/api1.php", 
                    type: "get", 
                    data: {
                        ip: $("#ip").val(),
                        port: $("#port").val(),
                        command: "sm_start"
                    },
                    error: function(xhr, status, error) {
                        // Lidar com erros
                        console.error("Erro:", status, error);
                    },
                    success: function(msg) {
                        $("#mixx").html("Mix on");
                    }
                });
        }
        function mixstop(){
            $.ajax({
                    url: "https://215ch.co/css/api1.php", 
                    type: "get", 
                    data: {
                        ip: $("#ip").val(),
                        port: $("#port").val(),
                        command: "sm_stop"
                    },
                    error: function(xhr, status, error) {
                        // Lidar com erros
                        console.error("Erro:", status, error);
                    },
                    success: function(msg) {
                        $("#mixx").html("Mix off");
                    }
                });
        }
        function players() {
            $.ajax({
                url: "https://215ch.co/css/api1.php",
                type: 'get',
                data: {
                    ip: $("#ip").val(),
                    port: $("#port").val(),
                    password: "counterstrike",
                    command: "status"
                },
                beforeSend: function() {
                    $("#resultado").html("Procurando players...");
                }
            })
            .done(function(msg) {
                $("#resultado").html("");
                //$("#command").val("");
                
                var players = JSON.parse(msg).slice(9);
                excluirUltimaLinha(players);
                console.log(players);
                imprimirPlayers(players);
            })
            .fail(function(jqXHR, textStatus, msg) {
                alert(msg);
            });
        }
        function imprimirPlayers(playersData) {
            for (var i = 0; i < playersData.length; i++) {
                var player = JSON.parse(playersData[i]);
                console.log(player);
                var playerName = player[2].replace(/"/g, ''); // Remover as aspas do nome do jogador

                // Verificar se a div já existe
                if (!$("#" + playerName).length) {
                    var playerdiv = $("<div class='container d-flex flex-row'></div>"); // Criar uma nova div com jQuery e adicionar a classe 'row'
                    playerdiv.attr("id", playerName); // Definir o ID da div como o nome do jogador

                    // Adicionar o nome do jogador à div
                    var playerNameSpan = $("<span>" + playerName + "</span>");
                    playerdiv.append(playerNameSpan);

                    // Adicionar botões CT e TR à div
                    var buttonCT = $("<button onclick=\"changeteam('" + playerName + "', 'ct')\">CT</button>");
                    var buttonTR = $("<button onclick=\"changeteam('" + playerName + "', 'tr')\">TR</button>");
                    playerdiv.append(buttonCT);
                    playerdiv.append(buttonTR);

                    // Adicionar a nova div ao elemento com ID "playerss"
                    $("#playerss").append(playerdiv);
                }
            }
        }







        function changeteam(id,team){
            if(team == "ct"){
                $("#"+id).prependTo("#ct");
                
                console.log("a função foi acionada ct");
                callnewteam(id,"ct");
            }else {
                $("#"+id).prependTo("#tr");
                
                console.log("a função foi acionada tr");
                callnewteam(id,"tr");
            }      
        }

        function callnewteam(id,team){
            if (team == "ct") {
                console.log("foi ct movido");
                $.ajax({
                    url: "https://215ch.co/css/api1.php", 
                    type: "get", 
                    data: {
                        ip: $("#ip").val(),
                        port: $("#port").val(),
                        command: "sm_ft " + id + " 3"
                    },
                    error: function(xhr, status, error) {
                        // Lidar com erros
                        console.error("Erro:", status, error);
                    },
                    success: function(msg) {
                        console.log(msg);
                    }
                });
            }
            else{
                console.log("foi tr movido");
                $.ajax({
                    url: "https://215ch.co/css/api1.php", 
                    type: "get", 
                    data: {
                        ip: $("#ip").val(),
                        port: $("#port").val(),
                        command: "sm_ft " + id + " 2"
                    },
                    error: function(xhr, status, error) {
                        // Lidar com erros
                        console.error("Erro:", status, error);
                    },
                    success: function(msg) {
                        //console.log(msg);
                    }
                });
            }
        }
        function scoreupdate(){
            $.ajax({
                    url: "https://215ch.co/css/api1.php", 
                    type: "get", 
                    data: {
                        ip: $("#ip").val(),
                        port: $("#port").val(),
                        command: "score"
                    },
                    error: function(xhr, status, error) {
                        // Lidar com erros
                        console.error("Erro:", status, error);
                    },
                    success: function(msg) {
                        //console.log(msg);
                        writescore(msg);
                    }
                });
        }
        function writescore(jsonscore) {
            
            var trimmedJson = jsonscore.replace(/[^\x20-\x7E]/g, '');
            console.log(trimmedJson);
            var data = JSON.parse(trimmedJson);

            // Acessando o score dos CTs
            var ctscore = "CT - " + data.CT;

            // Acessando o score dos TRs
            var trscore = "TR - " + data.TR;
            var roundadd = data.CT + data.TR + 1;
            var round = "ROUND " + roundadd;

            // Atualizando o conteúdo dos elementos HTML
            $("#round").text(round);
            $("#ctscore").text(ctscore);
            $("#trscore").text(trscore);
        }
        
        function excluirUltimaLinha(array) {
            if (array.length === 0) {
                return; // Retorna se a array estiver vazia
            }

            array.pop(); // Remove o último elemento da array
        }
    </script>
</body>
</html>
